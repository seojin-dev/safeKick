<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì‰´ë“œí‚¥ - ê¹€ì„œì§„</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/4.2.0/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/inferencejs"></script>
    <style>
      :root {
        --primary-color: #007aff;
        --danger-color: #ff3b30;
        --success-color: #34c759;
        --background-color: #f2f2f7;
        --card-color: #ffffff;
        --text-color: #000000;
        --secondary-text: #8e8e93;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, sans-serif;
      }

      body {
        background-color: var(--background-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
      }

      header {
        width: 100%;
        max-width: 800px;
        padding: 20px 0;
        text-align: center;
      }

      h1 {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 10px;
      }

      .container {
        width: 100%;
        max-width: 800px;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .card {
        background-color: var(--card-color);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      .cameras-container {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .camera-row {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
      }

      .camera-cell {
        flex: 1;
        min-width: 280px;
      }

      .camera-container {
        position: relative;
        width: 100%;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 8px;
        aspect-ratio: 4/3;
      }

      .camera-view {
        display: flex;
        flex-direction: column;
      }

      .camera-title {
        font-weight: 600;
        margin-bottom: 8px;
      }

      .video-element {
        width: 100%;
        height: 100%;
        border-radius: 12px;
        background-color: #000;
        object-fit: cover;
      }

      .canvas-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 12px;
      }

      .camera-label {
        font-weight: 600;
        margin-bottom: 4px;
        text-align: center;
        color: var(--primary-color);
      }

      .status-container {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .status-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 16px;
        border-radius: 12px;
        background-color: var(--background-color);
      }

      .status-label {
        font-weight: 600;
        font-size: 16px;
      }

      .status-value {
        font-weight: 500;
        color: var(--secondary-text);
      }

      .status-safe {
        color: var(--success-color);
      }

      .status-warning {
        color: var(--danger-color);
      }

      .alert {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 400px;
        padding: 20px;
        border-radius: 16px;
        background-color: var(--danger-color);
        color: white;
        font-weight: 600;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        display: none;
        animation: slideUp 0.3s ease-out forwards;
        z-index: 100;
      }

      /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
      .button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 12px;
        padding: 16px 24px;
        font-size: 16px;
        font-weight: 600;
        width: 100%;
        cursor: pointer;
        transition: background-color 0.2s;
        margin-top: 12px;
      }

      .button:hover {
        background-color: #0066cc;
      }

      .select-container {
        margin-bottom: 16px;
      }

      .select-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
      }

      .select {
        width: 100%;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #dee2e6;
        background-color: var(--card-color);
        font-size: 16px;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%238E8E93' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        cursor: pointer;
      }

      .camera-select-row {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }

      .camera-select-col {
        flex: 1;
        min-width: 280px;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translate(-50%, 20px);
        }
        to {
          opacity: 1;
          transform: translate(-50%, 0);
        }
      }

      .loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        gap: 16px;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(0, 122, 255, 0.2);
        border-radius: 50%;
        border-top-color: var(--primary-color);
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .bounding-box {
        position: absolute;
        border: 3px solid;
        border-radius: 4px;
        box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.5);
        pointer-events: none;
      }

      .helmet-box {
        border-color: var(--success-color);
      }

      .no-helmet-box {
        border-color: var(--danger-color);
      }

      .road-box {
        border-color: var(--success-color);
      }

      .sidewalk-box {
        border-color: var(--danger-color);
      }

      .crosswalk-box {
        border-color: var(--danger-color);
      }

      .box-label {
        position: absolute;
        top: -25px;
        left: 0;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        color: white;
      }

      .helmet-label {
        background-color: var(--success-color);
      }

      .no-helmet-label {
        background-color: var(--danger-color);
      }

      .road-label {
        background-color: var(--success-color);
      }

      .sidewalk-label {
        background-color: var(--danger-color);
      }

      .crosswalk-label {
        background-color: var(--danger-color);
      }
    </style>
  </head>
  <body>
    <header>
      <h1>ì‰´ë“œí‚¥</h1>
      <p>ê³µìœ í‚¥ë³´ë“œ ì´ìš©ìë¥¼ ìœ„í•œ ì•ˆì „ ì„œë¹„ìŠ¤</p>
    </header>

    <div class="container">
      <div class="card">
        <!-- ì¹´ë©”ë¼ ì„ íƒ UI -->
        <div class="camera-select-row">
          <div class="camera-select-col">
            <label for="frontCameraSelect" class="select-label"
              >ì „ë©´ ì¹´ë©”ë¼</label
            >
            <select id="frontCameraSelect" class="select">
              <option value="">ì¹´ë©”ë¼ ê²€ìƒ‰ ì¤‘...</option>
            </select>
          </div>
          <div class="camera-select-col">
            <label for="backCameraSelect" class="select-label"
              >í›„ë©´ ì¹´ë©”ë¼</label
            >
            <select id="backCameraSelect" class="select">
              <option value="">ì¹´ë©”ë¼ ê²€ìƒ‰ ì¤‘...</option>
            </select>
          </div>
        </div>

        <!-- ì–‘ìª½ ì¹´ë©”ë¼ ë™ì‹œ í‘œì‹œ -->
        <div class="cameras-container">
          <div class="camera-row">
            <!-- ì „ë©´ ì¹´ë©”ë¼ -->
            <div class="camera-cell">
              <div class="camera-label">ì „ë©´ ì¹´ë©”ë¼ (í—¬ë©§ ê°ì§€)</div>
              <div class="camera-container">
                <video
                  id="frontVideo"
                  class="video-element"
                  autoplay
                  playsinline
                ></video>
                <canvas id="frontCanvas" class="canvas-overlay"></canvas>
              </div>
            </div>

            <!-- í›„ë©´ ì¹´ë©”ë¼ -->
            <div class="camera-cell">
              <div class="camera-label">í›„ë©´ ì¹´ë©”ë¼ (ë„ë¡œ ê°ì§€)</div>
              <div class="camera-container">
                <video
                  id="backVideo"
                  class="video-element"
                  autoplay
                  playsinline
                ></video>
                <canvas id="backCanvas" class="canvas-overlay"></canvas>
              </div>
            </div>
          </div>
        </div>

        <button id="startButton" class="button">ì•ˆì „ ë¶„ì„ ì‹œì‘</button>
      </div>

      <div class="card status-container">
        <h2>ì•ˆì „ ìƒíƒœ</h2>
        <div class="status-item">
          <span class="status-label">í—¬ë©§ ì°©ìš©</span>
          <span id="helmetStatus" class="status-value">ë¶„ì„ ì „</span>
        </div>
        <div class="status-item">
          <span class="status-label">ì£¼í–‰ ìœ„ì¹˜</span>
          <span id="sidewalkStatus" class="status-value">ë¶„ì„ ì „</span>
        </div>
      </div>

      <div id="alert" class="alert">âš ï¸ ì†ë„ë¥¼ ê°ì†Œí•˜ê³  íƒ‘ìŠ¹ì„ ì¤‘ì§€í•˜ì„¸ìš”!</div>

      <div id="loading" class="card loading">
        <div class="spinner"></div>
        <p>ëª¨ë¸ì„ ë¡œë”©ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>
    </div>

    <script>
      // ì „ì—­ ë³€ìˆ˜
      let frontVideo = document.getElementById("frontVideo");
      let backVideo = document.getElementById("backVideo");
      let frontCanvas = document.getElementById("frontCanvas");
      let backCanvas = document.getElementById("backCanvas");
      let frontCtx, backCtx;
      let startButton = document.getElementById("startButton");
      let helmetStatus = document.getElementById("helmetStatus");
      let sidewalkStatus = document.getElementById("sidewalkStatus");
      let alert = document.getElementById("alert");
      let loading = document.getElementById("loading");
      let frontCameraSelect = document.getElementById("frontCameraSelect");
      let backCameraSelect = document.getElementById("backCameraSelect");

      let isAnalyzing = false;
      let frontStream = null;
      let backStream = null;
      let captureInterval = null;

      // ë¶„ì„ ê²°ê³¼ ì €ì¥
      let analysisResults = {
        hasHelmet: false,
        roadStatus: "ì•Œ ìˆ˜ ì—†ìŒ",
      };

      // Roboflow API í‚¤ì™€ ì—”ë“œí¬ì¸íŠ¸
      const HELMET_API_KEY = "Dpx7rudeMdqFJFVlCy7V";
      const HELMET_API_URL =
        "https://detect.roboflow.com/helmet-detector-9rzmg-bcuae/1";

      const SIDEWALK_API_KEY = "Dpx7rudeMdqFJFVlCy7V";
      const SIDEWALK_API_URL = "https://detect.roboflow.com/sidewalk-g81ja/1";

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          console.log("ğŸ“± ì•ˆì „í‚¥ ì•±ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.");
          loading.style.display = "none";

          // ì¹´ë©”ë¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          await getCameras();

          // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          startButton.addEventListener("click", toggleAnalysis);

          // ì¹´ë©”ë¼ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          frontCameraSelect.addEventListener("change", () =>
            changeFrontCamera()
          );
          backCameraSelect.addEventListener("change", () => changeBackCamera());
        } catch (error) {
          console.error("âŒ ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
          loading.innerHTML = `<p style="color: var(--danger-color)">ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>${error.message}</p>`;
        }
      });

      // ì‚¬ìš© ê°€ëŠ¥í•œ ì¹´ë©”ë¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
      async function getCameras() {
        try {
          console.log("ğŸ” ì‚¬ìš© ê°€ëŠ¥í•œ ì¹´ë©”ë¼ë¥¼ ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...");
          const devices = await navigator.mediaDevices.enumerateDevices();
          const videoDevices = devices.filter(
            (device) => device.kind === "videoinput"
          );

          frontCameraSelect.innerHTML = "";
          backCameraSelect.innerHTML = "";

          if (videoDevices.length === 0) {
            console.log("âš ï¸ ì‚¬ìš© ê°€ëŠ¥í•œ ì¹´ë©”ë¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
            const option = document.createElement("option");
            option.text = "ì‚¬ìš© ê°€ëŠ¥í•œ ì¹´ë©”ë¼ê°€ ì—†ìŠµë‹ˆë‹¤";
            frontCameraSelect.add(option.cloneNode(true));
            backCameraSelect.add(option);
          } else {
            console.log(`âœ… ${videoDevices.length}ê°œì˜ ì¹´ë©”ë¼ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`);

            // ëª¨ë°”ì¼ ê¸°ê¸°ì˜ ê²½ìš° ì „/í›„ë©´ ì¹´ë©”ë¼ êµ¬ë¶„ ì‹œë„
            const frontCameras = videoDevices.filter(
              (device) =>
                device.label.toLowerCase().includes("front") ||
                device.label.toLowerCase().includes("ì „ë©´")
            );
            const backCameras = videoDevices.filter(
              (device) =>
                device.label.toLowerCase().includes("back") ||
                device.label.toLowerCase().includes("í›„ë©´")
            );

            // ëª…ì‹œì ìœ¼ë¡œ êµ¬ë¶„ëœ ì¹´ë©”ë¼ê°€ ì—†ìœ¼ë©´ ëª¨ë“  ì¹´ë©”ë¼ë¥¼ ë³´ì—¬ì¤Œ
            const frontCameraList =
              frontCameras.length > 0 ? frontCameras : videoDevices;
            const backCameraList =
              backCameras.length > 0 ? backCameras : videoDevices;

            // ì „ë©´ ì¹´ë©”ë¼ ì˜µì…˜ ì¶”ê°€
            frontCameraList.forEach((device, index) => {
              const option = document.createElement("option");
              option.value = device.deviceId;
              option.text =
                frontCameras.length > 0
                  ? device.label || `ì „ë©´ ì¹´ë©”ë¼ ${index + 1}`
                  : device.label || `ì¹´ë©”ë¼ ${index + 1}`;
              frontCameraSelect.add(option);
              console.log(`ğŸ“· ì „ë©´ ì¹´ë©”ë¼ í›„ë³´ ${index + 1}: ${option.text}`);
            });

            // í›„ë©´ ì¹´ë©”ë¼ ì˜µì…˜ ì¶”ê°€
            backCameraList.forEach((device, index) => {
              const option = document.createElement("option");
              option.value = device.deviceId;
              option.text =
                backCameras.length > 0
                  ? device.label || `í›„ë©´ ì¹´ë©”ë¼ ${index + 1}`
                  : device.label || `ì¹´ë©”ë¼ ${index + 1}`;
              backCameraSelect.add(option);
              console.log(`ğŸ“· í›„ë©´ ì¹´ë©”ë¼ í›„ë³´ ${index + 1}: ${option.text}`);
            });

            // ì²« ë²ˆì§¸ ì¹´ë©”ë¼ë¡œ ì´ˆê¸°í™”
            await initFrontCamera(frontCameraSelect.value);
            await initBackCamera(backCameraSelect.value);
          }
        } catch (error) {
          console.error("âŒ ì¹´ë©”ë¼ ëª©ë¡ ì¡°íšŒ ì—ëŸ¬:", error);
        }
      }

      // ì „ë©´ ì¹´ë©”ë¼ ì´ˆê¸°í™”
      async function initFrontCamera(deviceId) {
        try {
          console.log("ğŸ¬ ì „ë©´ ì¹´ë©”ë¼ ì´ˆê¸°í™” ì¤‘...");
          const constraints = {
            video: {
              deviceId: deviceId ? { exact: deviceId } : undefined,
              facingMode: deviceId ? undefined : "user", // deviceIdê°€ ì—†ìœ¼ë©´ user(ì „ë©´) ëª¨ë“œ ì‹œë„
            },
          };

          if (frontStream) {
            frontStream.getTracks().forEach((track) => track.stop());
          }

          frontStream = await navigator.mediaDevices.getUserMedia(constraints);
          frontVideo.srcObject = frontStream;

          // ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„° ë¡œë“œ ì™„ë£Œ í›„ ìº”ë²„ìŠ¤ ì„¤ì •
          frontVideo.onloadedmetadata = () => {
            console.log(
              `âœ… ì „ë©´ ì¹´ë©”ë¼ ì¤€ë¹„ ì™„ë£Œ (í•´ìƒë„: ${frontVideo.videoWidth}x${frontVideo.videoHeight})`
            );
            frontCanvas.width = frontVideo.videoWidth;
            frontCanvas.height = frontVideo.videoHeight;
            frontCtx = frontCanvas.getContext("2d", {
              willReadFrequently: true,
            });
            frontCtx.lineWidth = 3;
            frontCtx.font = "14px sans-serif";
          };
        } catch (error) {
          console.error("âŒ ì „ë©´ ì¹´ë©”ë¼ ì´ˆê¸°í™” ì—ëŸ¬:", error);
        }
      }

      // í›„ë©´ ì¹´ë©”ë¼ ì´ˆê¸°í™”
      async function initBackCamera(deviceId) {
        try {
          console.log("ğŸ¬ í›„ë©´ ì¹´ë©”ë¼ ì´ˆê¸°í™” ì¤‘...");
          const constraints = {
            video: {
              deviceId: deviceId ? { exact: deviceId } : undefined,
              facingMode: deviceId ? undefined : "environment", // deviceIdê°€ ì—†ìœ¼ë©´ environment(í›„ë©´) ëª¨ë“œ ì‹œë„
            },
          };

          if (backStream) {
            backStream.getTracks().forEach((track) => track.stop());
          }

          backStream = await navigator.mediaDevices.getUserMedia(constraints);
          backVideo.srcObject = backStream;

          // ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„° ë¡œë“œ ì™„ë£Œ í›„ ìº”ë²„ìŠ¤ ì„¤ì •
          backVideo.onloadedmetadata = () => {
            console.log(
              `âœ… í›„ë©´ ì¹´ë©”ë¼ ì¤€ë¹„ ì™„ë£Œ (í•´ìƒë„: ${backVideo.videoWidth}x${backVideo.videoHeight})`
            );
            backCanvas.width = backVideo.videoWidth;
            backCanvas.height = backVideo.videoHeight;
            backCtx = backCanvas.getContext("2d", { willReadFrequently: true });
            backCtx.lineWidth = 3;
            backCtx.font = "14px sans-serif";
          };
        } catch (error) {
          console.error("âŒ í›„ë©´ ì¹´ë©”ë¼ ì´ˆê¸°í™” ì—ëŸ¬:", error);
        }
      }

      // ì „ë©´ ì¹´ë©”ë¼ ë³€ê²½
      async function changeFrontCamera() {
        const deviceId = frontCameraSelect.value;
        if (deviceId) {
          console.log("ğŸ”„ ì „ë©´ ì¹´ë©”ë¼ ë³€ê²½ ì¤‘...");
          await initFrontCamera(deviceId);

          // ë¶„ì„ ì¤‘ì´ë¼ë©´ ì¬ì‹œì‘
          if (isAnalyzing) {
            stopAnalysis();
            startAnalysis();
          }
        }
      }

      // í›„ë©´ ì¹´ë©”ë¼ ë³€ê²½
      async function changeBackCamera() {
        const deviceId = backCameraSelect.value;
        if (deviceId) {
          console.log("ğŸ”„ í›„ë©´ ì¹´ë©”ë¼ ë³€ê²½ ì¤‘...");
          await initBackCamera(deviceId);

          // ë¶„ì„ ì¤‘ì´ë¼ë©´ ì¬ì‹œì‘
          if (isAnalyzing) {
            stopAnalysis();
            startAnalysis();
          }
        }
      }

      // ë¶„ì„ ì‹œì‘/ì¤‘ì§€ í† ê¸€
      function toggleAnalysis() {
        if (isAnalyzing) {
          stopAnalysis();
        } else {
          startAnalysis();
        }
      }

      // ë¶„ì„ ì‹œì‘
      function startAnalysis() {
        isAnalyzing = true;
        startButton.textContent = "ì•ˆì „ ë¶„ì„ ì¤‘ì§€";
        console.log("ğŸš€ ì•ˆì „ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.");
        // 3ì´ˆë§ˆë‹¤ í”„ë ˆì„ ìº¡ì²˜ ë° ë¶„ì„
        captureInterval = setInterval(captureAndAnalyzeFrames, 3000);
        // ì²« í”„ë ˆì„ ì¦‰ì‹œ ë¶„ì„
        captureAndAnalyzeFrames();
      }

      // ë¶„ì„ ì¤‘ì§€
      function stopAnalysis() {
        isAnalyzing = false;
        startButton.textContent = "ì•ˆì „ ë¶„ì„ ì‹œì‘";
        helmetStatus.textContent = "ë¶„ì„ ì¤‘ì§€ë¨";
        sidewalkStatus.textContent = "ë¶„ì„ ì¤‘ì§€ë¨";
        hideAlert();
        clearBoundingBoxes();

        console.log("â¹ï¸ ì•ˆì „ ë¶„ì„ì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.");

        if (captureInterval) {
          clearInterval(captureInterval);
          captureInterval = null;
        }
      }

      // ë°”ìš´ë”© ë°•ìŠ¤ ì§€ìš°ê¸°
      function clearBoundingBoxes() {
        if (frontCtx) {
          frontCtx.clearRect(0, 0, frontCanvas.width, frontCanvas.height);
        }
        if (backCtx) {
          backCtx.clearRect(0, 0, backCanvas.width, backCanvas.height);
        }
      }

      // ë‘ ì¹´ë©”ë¼ì˜ ë¹„ë””ì˜¤ í”„ë ˆì„ ìº¡ì²˜ ë° ë¶„ì„
      async function captureAndAnalyzeFrames() {
        if (!isAnalyzing) return;

        try {
          console.log("ğŸ“¸ ì–‘ìª½ ì¹´ë©”ë¼ ì´ë¯¸ì§€ ìº¡ì²˜ ë° ë¶„ì„ ì¤‘...");

          // ì „ë©´ ì¹´ë©”ë¼ ë¶„ì„ (í—¬ë©§ ì°©ìš© ê°ì§€)
          await analyzeFrontCamera();

          // í›„ë©´ ì¹´ë©”ë¼ ë¶„ì„ (ë„ë¡œ ê°ì§€)
          await analyzeBackCamera();

          // ë¶„ì„ ê²°ê³¼ ì¢…í•© ì²˜ë¦¬
          updateSafetyStatus();
        } catch (error) {
          console.error("âŒ ì „ì²´ ë¶„ì„ ì˜¤ë¥˜:", error);
        }
      }

      // ì „ë©´ ì¹´ë©”ë¼ ë¶„ì„ (í—¬ë©§ ì°©ìš© ê°ì§€)
      async function analyzeFrontCamera() {
        if (!frontCtx) return;

        try {
          console.log("ğŸ“¸ ì „ë©´ ì¹´ë©”ë¼ ì´ë¯¸ì§€ ìº¡ì²˜ ë° ë¶„ì„ ì¤‘... (í—¬ë©§ ê°ì§€)");

          // í˜„ì¬ ë¹„ë””ì˜¤ í”„ë ˆì„ì„ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
          frontCtx.drawImage(
            frontVideo,
            0,
            0,
            frontCanvas.width,
            frontCanvas.height
          );

          // ìº”ë²„ìŠ¤ì˜ ì´ë¯¸ì§€ë¥¼ Base64ë¡œ ë³€í™˜
          const imageDataUrl = frontCanvas.toDataURL("image/jpeg", 0.8);
          const base64Image = imageDataUrl.split(",")[1];

          // í—¬ë©§ ë¶„ì„ ìš”ì²­
          console.log("ğŸª– í—¬ë©§ ê°ì§€ API í˜¸ì¶œ ì¤‘...");
          const helmetResult = await analyzeHelmet(base64Image);

          // í—¬ë©§ ê°ì§€ ê²°ê³¼ ì²˜ë¦¬
          processHelmetResults(helmetResult);
        } catch (error) {
          console.error("âŒ ì „ë©´ ì¹´ë©”ë¼ ë¶„ì„ ì˜¤ë¥˜:", error);
        }
      }

      // í›„ë©´ ì¹´ë©”ë¼ ë¶„ì„ (ë„ë¡œ ê°ì§€)
      async function analyzeBackCamera() {
        if (!backCtx) return;

        try {
          console.log("ğŸ“¸ í›„ë©´ ì¹´ë©”ë¼ ì´ë¯¸ì§€ ìº¡ì²˜ ë° ë¶„ì„ ì¤‘... (ë„ë¡œ ê°ì§€)");

          // í˜„ì¬ ë¹„ë””ì˜¤ í”„ë ˆì„ì„ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
          backCtx.drawImage(
            backVideo,
            0,
            0,
            backCanvas.width,
            backCanvas.height
          );

          // ìº”ë²„ìŠ¤ì˜ ì´ë¯¸ì§€ë¥¼ Base64ë¡œ ë³€í™˜
          const imageDataUrl = backCanvas.toDataURL("image/jpeg", 0.8);
          const base64Image = imageDataUrl.split(",")[1];

          // ë³´í–‰ë¡œ ë¶„ì„ ìš”ì²­
          console.log("ğŸ›£ï¸ ë³´í–‰ë¡œ ê°ì§€ API í˜¸ì¶œ ì¤‘...");
          const sidewalkResult = await analyzeSidewalk(base64Image);

          // ë„ë¡œ ê°ì§€ ê²°ê³¼ ì²˜ë¦¬
          processSidewalkResults(sidewalkResult);
        } catch (error) {
          console.error("âŒ í›„ë©´ ì¹´ë©”ë¼ ë¶„ì„ ì˜¤ë¥˜:", error);
        }
      }

      // í—¬ë©§ ê°ì§€ API í˜¸ì¶œ
      async function analyzeHelmet(base64Image) {
        try {
          const response = await fetch(
            `${HELMET_API_URL}?api_key=${HELMET_API_KEY}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: base64Image,
            }
          );

          if (!response.ok) {
            throw new Error(`API ì˜¤ë¥˜: ${response.status}`);
          }

          const result = await response.json();
          console.log("âœ… í—¬ë©§ ê°ì§€ API ì‘ë‹µ ë°›ìŒ:", result);
          return result;
        } catch (error) {
          console.error("âŒ í—¬ë©§ ê°ì§€ API ì˜¤ë¥˜:", error);
          return { predictions: [] };
        }
      }

      // ë³´í–‰ë¡œ ë¶„ë¥˜ API í˜¸ì¶œ
      async function analyzeSidewalk(base64Image) {
        try {
          const response = await fetch(
            `${SIDEWALK_API_URL}?api_key=${SIDEWALK_API_KEY}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: base64Image,
            }
          );

          if (!response.ok) {
            throw new Error(`API ì˜¤ë¥˜: ${response.status}`);
          }

          const result = await response.json();
          console.log("âœ… ë³´í–‰ë¡œ ê°ì§€ API ì‘ë‹µ ë°›ìŒ:", result);
          return result;
        } catch (error) {
          console.error("âŒ ë³´í–‰ë¡œ ê°ì§€ API ì˜¤ë¥˜:", error);
          return { predictions: [] };
        }
      }

      // í—¬ë©§ ê°ì§€ ê²°ê³¼ ì²˜ë¦¬
      function processHelmetResults(helmetData) {
        // ì „ë©´ ìº”ë²„ìŠ¤ ì§€ìš°ê¸°
        if (frontCtx) {
          frontCtx.clearRect(0, 0, frontCanvas.width, frontCanvas.height);
        }

        console.log("ğŸ“Š í—¬ë©§ ê°ì§€ ê²°ê³¼ ì²˜ë¦¬ ì¤‘...");

        // í—¬ë©§ ê°ì§€ ê²°ê³¼ ì²˜ë¦¬
        const helmetPredictions = helmetData.predictions || [];
        console.log(`ğŸ‘€ í—¬ë©§ ê°ì§€: ${helmetPredictions.length}ê°œ ê°ì²´ ë°œê²¬`);

        // ê°ì§€ëœ ê°ì²´ ë¡œê·¸
        if (helmetPredictions.length > 0) {
          helmetPredictions.forEach((pred, idx) => {
            console.log(
              `   ê°ì²´ ${idx + 1}: ${pred.class} (ì‹ ë¢°ë„: ${(
                pred.confidence * 100
              ).toFixed(1)}%)`
            );
          });
        } else {
          console.log("   ê°ì§€ëœ ê°ì²´ ì—†ìŒ");
        }

        // helmetê³¼ nutshell ëª¨ë‘ í—¬ë©§ìœ¼ë¡œ ì¸ì‹ (helmetì´ë‚˜ nutshellì„ í¬í•¨í•˜ëŠ” ì´ë¦„ë„ í¬í•¨)
        const helmets = helmetPredictions.filter(
          (pred) =>
            (pred.class.toLowerCase().includes("helmet") ||
              pred.class.toLowerCase().includes("nutshell")) &&
            pred.confidence > 0.4
        );
        analysisResults.hasHelmet = helmets.length > 0;

        // í—¬ë©§ ë°”ìš´ë”© ë°•ìŠ¤ ê·¸ë¦¬ê¸°
        if (helmets.length > 0) {
          console.log(`ğŸª– í—¬ë©§ ì°©ìš© ê°ì§€: ${helmets.length}ê°œ`);
          helmets.forEach((helmet) => {
            // ë°”ìš´ë”© ë°•ìŠ¤ ì¢Œí‘œ ê³„ì‚° ìˆ˜ì •
            const x = helmet.x - helmet.width / 2;
            const y = helmet.y - helmet.height / 2;

            drawBoundingBox(
              frontCtx,
              x,
              y,
              helmet.width,
              helmet.height,
              "helmet"
            );
          });
        } else {
          // í—¬ë©§ì´ ê°ì§€ë˜ì§€ ì•ŠìŒ - ì‚¬ëŒì´ ê°ì§€ëœ ê²½ìš° 'ë¯¸ì°©ìš©' í‘œì‹œ
          const persons = helmetPredictions.filter(
            (pred) =>
              pred.class.toLowerCase() === "person" && pred.confidence > 0.4
          );
          if (persons.length > 0) {
            console.log(`âš ï¸ í—¬ë©§ ë¯¸ì°©ìš© ì¸ì› ê°ì§€: ${persons.length}ëª…`);
            persons.forEach((person) => {
              // ë°”ìš´ë”© ë°•ìŠ¤ ì¢Œí‘œ ê³„ì‚° ìˆ˜ì •
              const x = person.x - person.width / 2;
              const y = person.y - person.height / 2;

              drawBoundingBox(
                frontCtx,
                x,
                y,
                person.width,
                person.height,
                "no-helmet"
              );
            });
          } else {
            console.log("ğŸ‘¤ ì¸ì‹ëœ ì‚¬ëŒ ì—†ìŒ");
          }
        }
      }

      // ë³´í–‰ë¡œ ê°ì§€ ê²°ê³¼ ì²˜ë¦¬
      function processSidewalkResults(sidewalkData) {
        // í›„ë©´ ìº”ë²„ìŠ¤ ì§€ìš°ê¸°
        if (backCtx) {
          backCtx.clearRect(0, 0, backCanvas.width, backCanvas.height);
        }

        console.log("ğŸ“Š ë³´í–‰ë¡œ ê°ì§€ ê²°ê³¼ ì²˜ë¦¬ ì¤‘...");

        // ë³´í–‰ë¡œ ê°ì§€ ê²°ê³¼ ì²˜ë¦¬
        const sidewalkPredictions = sidewalkData.predictions || [];
        console.log(
          `ğŸ‘€ ë³´í–‰ë¡œ ê°ì§€: ${sidewalkPredictions.length}ê°œ ê°ì²´ ë°œê²¬`
        );

        // ê°ì§€ëœ ê°ì²´ ë¡œê·¸
        if (sidewalkPredictions.length > 0) {
          sidewalkPredictions.forEach((pred, idx) => {
            console.log(
              `   ê°ì²´ ${idx + 1}: ${pred.class} (ì‹ ë¢°ë„: ${(
                pred.confidence * 100
              ).toFixed(1)}%)`
            );
          });
        } else {
          console.log("   ê°ì§€ëœ ê°ì²´ ì—†ìŒ");
        }

        let currentLocation = "ì•Œ ìˆ˜ ì—†ìŒ";
        let highestConf = 0;

        // ê°€ì¥ ë†’ì€ ì‹ ë¢°ë„ë¥¼ ê°€ì§„ ìœ„ì¹˜ ì°¾ê¸°
        for (const pred of sidewalkPredictions) {
          if (pred.confidence > highestConf) {
            highestConf = pred.confidence;
            currentLocation = pred.class;
          }
        }

        // ê²°ê³¼ ì €ì¥
        analysisResults.roadStatus = currentLocation;

        // ë³´í–‰ë¡œ ë°”ìš´ë”© ë°•ìŠ¤ ê·¸ë¦¬ê¸°
        if (sidewalkPredictions.length > 0) {
          console.log(`ğŸ›£ï¸ ì£¼í–‰ ìœ„ì¹˜ ê°ì§€: ${currentLocation}`);
          const locationBoxType =
            currentLocation === "road"
              ? "road"
              : currentLocation === "sidewalk"
              ? "sidewalk"
              : "crosswalk";

          // ì´ë¯¸ì§€ í•˜ë‹¨ì— ìœ„ì¹˜ í‘œì‹œ
          drawBoundingBox(
            backCtx,
            0,
            backCanvas.height * 0.7,
            backCanvas.width,
            backCanvas.height * 0.3,
            locationBoxType
          );
        } else {
          console.log("ğŸ›£ï¸ ì£¼í–‰ ìœ„ì¹˜ ê°ì§€ ì‹¤íŒ¨");
        }
      }

      // ë°”ìš´ë”© ë°•ìŠ¤ ê·¸ë¦¬ê¸°
      function drawBoundingBox(ctx, x, y, width, height, type) {
        // ìœ íš¨í•œ ìº”ë²„ìŠ¤ ì»¨í…ìŠ¤íŠ¸ í™•ì¸
        if (!ctx) return;

        // ìœ íš¨í•œ ì¢Œí‘œê°’ì¸ì§€ í™•ì¸
        if (isNaN(x) || isNaN(y) || isNaN(width) || isNaN(height)) {
          console.error("âŒ ë°”ìš´ë”© ë°•ìŠ¤ ì¢Œí‘œ ì˜¤ë¥˜:", { x, y, width, height });
          return;
        }

        try {
          // ë°”ìš´ë”© ë°•ìŠ¤ ì¢Œí‘œ ë³´ì • (ìº”ë²„ìŠ¤ ì˜ì—­ì„ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡)
          const canvas = ctx.canvas;
          const boxX = Math.max(0, Math.min(x, canvas.width - 1));
          const boxY = Math.max(0, Math.min(y, canvas.height - 1));
          const boxWidth = Math.min(width, canvas.width - boxX);
          const boxHeight = Math.min(height, canvas.height - boxY);

          // ë°”ìš´ë”© ë°•ìŠ¤ ìƒ‰ìƒê³¼ ë¼ë²¨ ì„¤ì •
          let labelText;

          switch (type) {
            case "helmet":
              labelText = "í—¬ë©§ ì°©ìš©";
              ctx.strokeStyle = "#34C759"; // ë…¹ìƒ‰
              ctx.fillStyle = "#34C759";
              break;
            case "no-helmet":
              labelText = "í—¬ë©§ ë¯¸ì°©ìš©";
              ctx.strokeStyle = "#FF3B30"; // ë¹¨ê°„ìƒ‰
              ctx.fillStyle = "#FF3B30";
              break;
            case "road":
              labelText = "ë„ë¡œ";
              ctx.strokeStyle = "#34C759"; // ë…¹ìƒ‰
              ctx.fillStyle = "#34C759";
              break;
            case "sidewalk":
              labelText = "ì¸ë„";
              ctx.strokeStyle = "#FF3B30"; // ë¹¨ê°„ìƒ‰
              ctx.fillStyle = "#FF3B30";
              break;
            case "crosswalk":
              labelText = "íš¡ë‹¨ë³´ë„";
              ctx.strokeStyle = "#FF3B30"; // ë¹¨ê°„ìƒ‰
              ctx.fillStyle = "#FF3B30";
              break;
            default:
              labelText = "ì•Œ ìˆ˜ ì—†ìŒ";
              ctx.strokeStyle = "#5AC8FA"; // íŒŒë€ìƒ‰
              ctx.fillStyle = "#5AC8FA";
          }

          // ë°”ìš´ë”© ë°•ìŠ¤ ê·¸ë¦¬ê¸°
          ctx.beginPath();
          ctx.rect(boxX, boxY, boxWidth, boxHeight);
          ctx.stroke();

          // ë¼ë²¨ ë°°ê²½ ê·¸ë¦¬ê¸°
          const labelWidth = ctx.measureText(labelText).width + 10;
          const labelY = Math.max(boxY - 20, 0); // í™”ë©´ ìƒë‹¨ì„ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡
          ctx.fillRect(boxX, labelY, labelWidth, 20);

          // ë¼ë²¨ í…ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
          ctx.fillStyle = "#FFFFFF"; // í°ìƒ‰ í…ìŠ¤íŠ¸
          ctx.fillText(labelText, boxX + 5, labelY + 15);
        } catch (error) {
          console.error("âŒ ë°”ìš´ë”© ë°•ìŠ¤ ê·¸ë¦¬ê¸° ì˜¤ë¥˜:", error);
        }
      }

      // ì „ì²´ ì•ˆì „ ìƒíƒœ ì—…ë°ì´íŠ¸
      function updateSafetyStatus() {
        console.log("ğŸ“ ì¢…í•© ì•ˆì „ ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘...");

        const hasHelmet = analysisResults.hasHelmet;
        const roadStatus = analysisResults.roadStatus;

        // í—¬ë©§ ìƒíƒœ
        if (hasHelmet) {
          helmetStatus.textContent = "ì°©ìš© âœ“";
          helmetStatus.className = "status-value status-safe";
        } else {
          helmetStatus.textContent = "ë¯¸ì°©ìš© âœ—";
          helmetStatus.className = "status-value status-warning";
        }

        // ì£¼í–‰ ìœ„ì¹˜ ìƒíƒœ ì—…ë°ì´íŠ¸
        sidewalkStatus.textContent = roadStatus;

        // ë„ë¡œì¼ ê²½ìš°ë§Œ ì •ìƒ
        const isSafeLocation = roadStatus === "road";

        if (isSafeLocation) {
          sidewalkStatus.className = "status-value status-safe";
        } else {
          sidewalkStatus.className = "status-value status-warning";
        }

        // ê²½ê³  í‘œì‹œ ì—¬ë¶€
        if (!hasHelmet || !isSafeLocation) {
          showAlert();
        } else {
          hideAlert();
        }

        // ìµœì¢… íŒì • ê²°ê³¼ í‘œì‹œ
        console.log("ğŸ“ ë¶„ì„ ê²°ê³¼ ìš”ì•½:");
        console.log(`   í—¬ë©§ ì°©ìš©: ${hasHelmet ? "âœ… ì°©ìš©" : "âŒ ë¯¸ì°©ìš©"}`);
        console.log(
          `   ì£¼í–‰ ìœ„ì¹˜: ${roadStatus} (${
            roadStatus === "road" ? "âœ… ì•ˆì „" : "âŒ ìœ„í—˜"
          })`
        );
        console.log(
          `   ì¢…í•© íŒì •: ${hasHelmet && isSafeLocation ? "âœ… ì•ˆì „" : "âŒ ìœ„í—˜"}`
        );
      }

      // ê²½ê³ ì°½ í‘œì‹œ
      function showAlert() {
        alert.style.display = "block";
      }

      // ê²½ê³ ì°½ ìˆ¨ê¸°ê¸°
      function hideAlert() {
        alert.style.display = "none";
      }
    </script>
  </body>
</html>
